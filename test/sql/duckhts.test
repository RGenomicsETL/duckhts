# name: test/sql/duckhts.test
# description: Test duckhts extension – read_bcf, read_bam, read_fasta, read_fastq, read_gff, read_gtf, read_tabix
# group: [duckhts]
#
# Test data lives in test/data/ and is prepared by test/scripts/prepare_test_data.sh
# which copies files from vendored htslib and builds the required indexes.

require duckhts

# ==============================================================
# read_bcf – VCF/BCF reader
# ==============================================================

# --- record count (bgzipped VCF) ---
query I
SELECT count(*) FROM read_bcf('__WORKING_DIRECTORY__/test/data/formatcols.vcf.gz');
----
1

# --- first row fixed columns ---
query IIIT
SELECT CHROM, POS, ID, REF FROM read_bcf('__WORKING_DIRECTORY__/test/data/formatcols.vcf.gz') LIMIT 1;
----
1	100	a	A

# --- larger BCF file ---
query I
SELECT count(*) FROM read_bcf('__WORKING_DIRECTORY__/test/data/vcf_file.bcf');
----
15

# --- first three rows of the BCF ---
query III
SELECT CHROM, POS, REF FROM read_bcf('__WORKING_DIRECTORY__/test/data/vcf_file.bcf') LIMIT 3;
----
1	3000150	C
1	3000151	C
1	3062915	GTTT

# --- BCF region query ---
query I
SELECT count(*) FROM read_bcf('__WORKING_DIRECTORY__/test/data/vcf_file.bcf', region := '1:3000150-3000151');
----
2

# --- BCF multi-region query (comma-separated) ---
query I
WITH r1 AS (
  SELECT count(*) AS c FROM read_bcf('__WORKING_DIRECTORY__/test/data/vcf_file.bcf', region := '1:3000150-3000151')
),
r2 AS (
  SELECT count(*) AS c FROM read_bcf('__WORKING_DIRECTORY__/test/data/vcf_file.bcf', region := '1:3062915-3062915')
),
mr AS (
  SELECT count(*) AS c FROM read_bcf('__WORKING_DIRECTORY__/test/data/vcf_file.bcf', region := '1:3000150-3000151,1:3062915-3062915')
)
SELECT CASE WHEN (SELECT c FROM mr) = (SELECT c FROM r1) + (SELECT c FROM r2) THEN 1 ELSE 0 END;
----
1

# --- VEP/CSQ annotations (if present) ---
query I
SELECT CASE WHEN VEP_Allele IS NOT NULL THEN 1 ELSE 0 END
FROM read_bcf('__WORKING_DIRECTORY__/test/data/test_vep.vcf')
LIMIT 1;
----
1

# ==============================================================
# read_bam – SAM/BAM/CRAM reader
# ==============================================================

# --- record count ---
query I
SELECT count(*) FROM read_bam('__WORKING_DIRECTORY__/test/data/range.bam');
----
112

# --- first row ---
query IIIII
SELECT QNAME, FLAG, RNAME, POS, MAPQ FROM read_bam('__WORKING_DIRECTORY__/test/data/range.bam') LIMIT 1;
----
HS18_09653:4:1315:19857:61712	145	CHROMOSOME_I	914	23

# --- region query (full contig) ---
query I
SELECT count(*) FROM read_bam('__WORKING_DIRECTORY__/test/data/range.bam', region := 'CHROMOSOME_I');
----
18

# --- region query (sub-range) ---
query I
SELECT count(*) FROM read_bam('__WORKING_DIRECTORY__/test/data/range.bam', region := 'CHROMOSOME_I:1-1000');
----
2

# --- BAM multi-region query (dedup on overlapping regions) ---
query I
WITH single_region AS (
  SELECT count(*) AS c FROM read_bam('__WORKING_DIRECTORY__/test/data/range.bam', region := 'CHROMOSOME_I:1-1000')
),
multi_region AS (
  SELECT count(*) AS c FROM read_bam('__WORKING_DIRECTORY__/test/data/range.bam', region := 'CHROMOSOME_I:1-1000,CHROMOSOME_I:1-1000')
)
SELECT CASE WHEN (SELECT c FROM single_region) = (SELECT c FROM multi_region) THEN 1 ELSE 0 END;
----
1

# --- read group / sample ---
query I
SELECT count(*) FROM read_bam('__WORKING_DIRECTORY__/test/data/rg.sam.gz') WHERE READ_GROUP_ID IS NOT NULL;
----
4

query I
SELECT count(*) FROM read_bam('__WORKING_DIRECTORY__/test/data/rg.sam.gz') WHERE SAMPLE_ID = 'x1';
----
2

query I
SELECT count(*) FROM read_bam('__WORKING_DIRECTORY__/test/data/rg.sam.gz') WHERE SAMPLE_ID = 'x2';
----
2

# --- standard tags + auxiliary tags ---
query III
SELECT RG, NM, map_extract(AUXILIARY_TAGS, 'XZ')
FROM read_bam('__WORKING_DIRECTORY__/test/data/aux_tags.sam.gz', standard_tags := true, auxiliary_tags := true)
LIMIT 1;
----
x1	2	[foo]

# --- CRAM with explicit reference ---
query I
SELECT CASE WHEN count(*) > 0 THEN 1 ELSE 0 END FROM read_bam('__WORKING_DIRECTORY__/test/data/range.cram', reference := '__WORKING_DIRECTORY__/test/data/ce.fa');
----
1

# ==============================================================
# read_fasta – FASTA reader
# ==============================================================

# --- record count ---
query I
SELECT count(*) FROM read_fasta('__WORKING_DIRECTORY__/test/data/ce.fa');
----
7

# --- first sequence name ---
query I
SELECT NAME FROM read_fasta('__WORKING_DIRECTORY__/test/data/ce.fa') LIMIT 1;
----
CHROMOSOME_I

# --- sequence lengths of first 3 ---
query II
SELECT NAME, length(SEQUENCE) FROM read_fasta('__WORKING_DIRECTORY__/test/data/ce.fa') LIMIT 3;
----
CHROMOSOME_I	1009800
CHROMOSOME_II	5000
CHROMOSOME_III	5000

# --- region query using FASTA index (.fai) ---
query II
SELECT NAME, length(SEQUENCE)
FROM read_fasta('__WORKING_DIRECTORY__/test/data/ce.fa', region := 'CHROMOSOME_I:1-10');
----
CHROMOSOME_I	10

# --- multi-region query (comma-separated) ---
query I
SELECT count(*)
FROM read_fasta('__WORKING_DIRECTORY__/test/data/ce.fa', region := 'CHROMOSOME_I:1-10,CHROMOSOME_II:1-5');
----
2

# --- explicit index build helper ---
query I
SELECT success::INT FROM fasta_index('__WORKING_DIRECTORY__/test/data/ce.fa');
----
1

# ==============================================================
# read_fastq – FASTQ reader
# ==============================================================

# --- record count ---
query I
SELECT count(*) FROM read_fastq('__WORKING_DIRECTORY__/test/data/r1.fq');
----
5

# --- first row: name and lengths ---
query III
SELECT NAME, length(SEQUENCE), length(QUALITY) FROM read_fastq('__WORKING_DIRECTORY__/test/data/r1.fq') LIMIT 1;
----
HS25_09827:2:1201:1505:59795#49	100	100

# --- paired FASTQ (mate_path) ---
query I
SELECT count(*) FROM read_fastq('__WORKING_DIRECTORY__/test/data/r1.fq', mate_path := '__WORKING_DIRECTORY__/test/data/r2.fq');
----
10

query I
SELECT count(*) FROM read_fastq('__WORKING_DIRECTORY__/test/data/r1.fq', mate_path := '__WORKING_DIRECTORY__/test/data/r2.fq') WHERE MATE = 1;
----
5

query I
SELECT count(*) FROM read_fastq('__WORKING_DIRECTORY__/test/data/r1.fq', mate_path := '__WORKING_DIRECTORY__/test/data/r2.fq') WHERE MATE = 2;
----
5

query I
SELECT count(DISTINCT PAIR_ID) FROM read_fastq('__WORKING_DIRECTORY__/test/data/r1.fq', mate_path := '__WORKING_DIRECTORY__/test/data/r2.fq');
----
5

# --- paired FASTQ mismatch (mate_path) ---
statement error
SELECT count(*) FROM read_fastq('__WORKING_DIRECTORY__/test/data/mate_mismatch_r1.fq', mate_path := '__WORKING_DIRECTORY__/test/data/mate_mismatch_r2.fq');
----
read_fastq: mate files out of sync (QNAME mismatch: 'readA' vs 'readB')

# --- interleaved FASTQ ---
query I
SELECT count(*) FROM read_fastq('__WORKING_DIRECTORY__/test/data/interleaved.fq', interleaved := true);
----
10

query I
SELECT count(*) FROM read_fastq('__WORKING_DIRECTORY__/test/data/interleaved.fq', interleaved := true) WHERE MATE = 1;
----
5

query I
SELECT count(*) FROM read_fastq('__WORKING_DIRECTORY__/test/data/interleaved.fq', interleaved := true) WHERE MATE = 2;
----
5

query I
SELECT count(DISTINCT PAIR_ID) FROM read_fastq('__WORKING_DIRECTORY__/test/data/interleaved.fq', interleaved := true);
----
5

# --- interleaved FASTQ odd record count ---
statement error
SELECT count(*) FROM read_fastq('__WORKING_DIRECTORY__/test/data/odd_interleaved.fq', interleaved := true);
----
read_fastq: interleaved file has an unpaired record

# ==============================================================
# read_bcf – VCF/BCF reader
# ==============================================================

# --- non-conforming VCF without ##contig ---
query I
SELECT count(*) FROM read_bcf('__WORKING_DIRECTORY__/test/data/no_contig.vcf.gz');
----
1

# --- region query with missing contig headers (non-conforming VCF) ---
query I
SELECT count(*) FROM read_bcf('__WORKING_DIRECTORY__/test/data/no_contig.vcf.gz', region := 'no_such_contig:1-10');
----
0

# ==============================================================
# read_gff – GFF3 reader (bgzipped + tabix indexed)
# ==============================================================

# --- record count ---
query I
SELECT count(*) FROM read_gff('__WORKING_DIRECTORY__/test/data/gff_file.gff.gz');
----
62

# --- first row ---
query IIIII
SELECT seqname, source, feature, start, "end" FROM read_gff('__WORKING_DIRECTORY__/test/data/gff_file.gff.gz') LIMIT 1;
----
X	Vega	exon	2934816	2935190

# ==============================================================
# read_tabix – generic reader (header/meta)
# ==============================================================

# --- respect meta header lines in generic tabix ---
query II
SELECT column0, column1 FROM read_tabix('__WORKING_DIRECTORY__/test/data/meta_tabix.tsv.gz') LIMIT 1;
----
chr1	1

# --- use header row as column names ---
query II
SELECT chrom, pos FROM read_tabix('__WORKING_DIRECTORY__/test/data/header_tabix.tsv.gz', header := true) LIMIT 1;
----
chr1	1

# --- override column names explicitly ---
query II
SELECT chrom, pos FROM read_tabix('__WORKING_DIRECTORY__/test/data/meta_tabix.tsv.gz', header_names := ['chrom','pos','value']) LIMIT 1;
----
chr1	1

# --- auto-detect column types ---
query I
SELECT typeof(column1) FROM read_tabix('__WORKING_DIRECTORY__/test/data/meta_tabix.tsv.gz', auto_detect := true) LIMIT 1;
----
BIGINT

# --- override column types ---
query I
SELECT pos + 1 FROM read_tabix('__WORKING_DIRECTORY__/test/data/header_tabix.tsv.gz', header := true, column_types := ['VARCHAR','BIGINT','VARCHAR']) LIMIT 1;
----
2

# --- projection pushdown: single column ---
query I
SELECT feature FROM read_gff('__WORKING_DIRECTORY__/test/data/gff_file.gff.gz') LIMIT 1;
----
exon

# --- feature counts ---
query II
SELECT feature, count(*) as cnt FROM read_gff('__WORKING_DIRECTORY__/test/data/gff_file.gff.gz') GROUP BY feature ORDER BY cnt DESC;
----
exon	23
intron	19
CDS	15
transcript	4
gene	1

# --- GFF region query ---
query I
SELECT count(*) FROM read_gff('__WORKING_DIRECTORY__/test/data/gff_file.gff.gz', region := 'X:2934816-2935190');
----
4

# --- attributes_map ---
query I
SELECT count(*) FROM read_gff('__WORKING_DIRECTORY__/test/data/gff_file.gff.gz', attributes_map := true) WHERE attributes_map IS NOT NULL;
----
62

# ==============================================================
# read_tabix – generic tabix reader (bgzipped + tabix indexed)
# ==============================================================

# --- record count ---
query I
SELECT count(*) FROM read_tabix('__WORKING_DIRECTORY__/test/data/gff_file.gff.gz');
----
62

# --- projection pushdown on generic tabix ---
query II
SELECT column0, column2 FROM read_tabix('__WORKING_DIRECTORY__/test/data/gff_file.gff.gz') LIMIT 2;
----
X	exon
X	gene

# --- tabix region query ---
query I
SELECT count(*) FROM read_tabix('__WORKING_DIRECTORY__/test/data/gff_file.gff.gz', region := 'X:2934816-2935190');
----
4

# --- tabix multi-region query (comma-separated) ---
query I
WITH r1 AS (
  SELECT count(*) AS c FROM read_tabix('__WORKING_DIRECTORY__/test/data/gff_file.gff.gz', region := 'X:2934816-2935190')
),
r2 AS (
  SELECT count(*) AS c FROM read_tabix('__WORKING_DIRECTORY__/test/data/gff_file.gff.gz', region := 'X:2937010-2937500')
),
mr AS (
  SELECT count(*) AS c FROM read_tabix('__WORKING_DIRECTORY__/test/data/gff_file.gff.gz', region := 'X:2934816-2935190,X:2937010-2937500')
)
SELECT CASE WHEN (SELECT c FROM mr) = (SELECT c FROM r1) + (SELECT c FROM r2) THEN 1 ELSE 0 END;
----
1

# ==============================================================
# read_hts_header & read_hts_index
# ==============================================================

# --- header map extraction (VCF) ---
query T
SELECT map_extract(key_values, 'Description')
FROM read_hts_header('__WORKING_DIRECTORY__/test/data/formatcols.vcf.gz')
WHERE record_type = 'FORMAT'
LIMIT 1;
----
['"Text"']

# --- raw header mode ---
query I
SELECT count(*)
FROM read_hts_header('__WORKING_DIRECTORY__/test/data/formatcols.vcf.gz', mode := 'raw')
WHERE raw LIKE '##%';
----
6

# --- index type extracted from VCF/BCF ---
query I
SELECT index_type
FROM read_hts_index('__WORKING_DIRECTORY__/test/data/formatcols.vcf.gz')
LIMIT 1;
----
CSI

# --- index spans macro available ---
query I
SELECT count(*)
FROM read_hts_index_spans('__WORKING_DIRECTORY__/test/data/formatcols.vcf.gz');
----
1

# --- index raw macro available ---
query I
SELECT CASE WHEN octet_length(raw) > 0 THEN 1 ELSE 0 END
FROM read_hts_index_raw('__WORKING_DIRECTORY__/test/data/formatcols.vcf.gz');
----
1

# --- explicit index_path for read_bcf ---
query I
SELECT count(*)
FROM read_bcf(
  '__WORKING_DIRECTORY__/test/data/vcf_file.bcf',
  region := '1:3000150-3000151',
  index_path := '__WORKING_DIRECTORY__/test/data/vcf_file.bcf.csi'
);
----
2

# --- explicit index_path for read_bam ---
query I
SELECT count(*)
FROM read_bam(
  '__WORKING_DIRECTORY__/test/data/range.bam',
  region := 'CHROMOSOME_I:1-1000',
  index_path := '__WORKING_DIRECTORY__/test/data/range.bam.bai'
);
----
2
