---
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

# Rduckhts: DuckDB HTS File Reader Extension for R

[![CRAN Status](https://www.r-pkg.org/badges/version/Rduckhts)](https://cran.r-project.org/package=Rduckhts) [![R-CMD-check](https://github.com/RGenomicsETL/duckhts/workflows/CRAN-check/badge.svg)](https://github.com/RGenomicsETL/duckhts/actions)

We provide an R interface to the DuckDB HTS (High Throughput Sequencing) file reader extension. We enable reading common bioinformatics file formats such as VCF/BCF, SAM/BAM/CRAM, FASTA, FASTQ, GFF, GTF, and tabix-indexed files directly from R using SQL queries via DuckDB.

## Key Features

We follow the RBCFTools table pattern and create DuckDB tables instead of returning data frames. We support VCF/BCF, SAM/BAM/CRAM, FASTA, FASTQ, GFF, GTF, and tabix. We support region queries for indexed files, and we target Linux, macOS, and Windows (MinGW). We bundle htslib 1.23 so runtime dependencies stay minimal.

## Installation

We install from GitHub with `remotes::install_github("RGenomicsETL/duckhts", subdir = "r/Rduckhts")`.

## Quick Start (runnable example)

```{r}
library(DBI)
library(duckdb)
library(Rduckhts)

ext_path <- system.file("extdata", "duckhts.duckdb_extension", package = "Rduckhts")
if (!file.exists(ext_path)) {
	ext_path <- file.path("inst", "extdata", "duckhts.duckdb_extension")
}
if (!file.exists(ext_path)) {
	stop("DuckHTS extension not found at: ", ext_path)
}

fasta_path <- system.file("extdata", "ce.fa", package = "Rduckhts")
fastq_r1 <- system.file("extdata", "r1.fq", package = "Rduckhts")
fastq_r2 <- system.file("extdata", "r2.fq", package = "Rduckhts")

if (!file.exists(fasta_path) || !file.exists(fastq_r1) || !file.exists(fastq_r2)) {
	stop("Example data files not found in extdata")
}

con <- dbConnect(duckdb::duckdb(config = list(allow_unsigned_extensions = "true")))
rduckhts_load(con, extension_path = ext_path)

rduckhts_fasta(con, "sequences", fasta_path, overwrite = TRUE)
rduckhts_fastq(con, "reads", fastq_r1, mate_path = fastq_r2, overwrite = TRUE)

dbGetQuery(con, "SELECT COUNT(*) AS n FROM sequences")
dbGetQuery(con, "SELECT COUNT(*) AS n FROM reads")

message("Loaded example data and created tables.")
```

We load the extension with `rduckhts_load(con, extension_path = NULL)`. We create tables with `rduckhts_bcf`, `rduckhts_bam`, `rduckhts_fasta`, `rduckhts_fastq`, `rduckhts_gff`, `rduckhts_gtf`, and `rduckhts_tabix` using the parameters documented in their help pages.

## Advanced Examples

### Region Queries

```{r}
bcf_path <- system.file("extdata", "vcf_file.bcf", package = "Rduckhts")
rduckhts_bcf(con, "variants", bcf_path, overwrite = TRUE)
variants <- dbGetQuery(con, "SELECT * FROM variants LIMIT 5")
variants
```

```{r}
r1 <- system.file("extdata", "r1.fq", package = "Rduckhts")
r2 <- system.file("extdata", "r2.fq", package = "Rduckhts")
interleaved <- system.file("extdata", "interleaved.fq", package = "Rduckhts")
rduckhts_fastq(con, "paired_reads", r1, mate_path = r2, overwrite = TRUE)
rduckhts_fastq(con, "interleaved_reads", interleaved, interleaved = TRUE, overwrite = TRUE)
pairs <- dbGetQuery(con, "SELECT * FROM paired_reads WHERE MATE = 1 LIMIT 5")
pairs
```

```{r}
gff_path <- system.file("extdata", "gff_file.gff.gz", package = "Rduckhts")
rduckhts_gff(con, "genes", gff_path, attributes_map = TRUE, overwrite = TRUE)
gene_annotations <- dbGetQuery(con, "SELECT seqname, start, \"end\" FROM genes WHERE feature = 'gene' LIMIT 5")
gene_annotations
```

```{r}
cram_path <- system.file("extdata", "range.cram", package = "Rduckhts")
ref_path <- system.file("extdata", "ce.fa", package = "Rduckhts")
rduckhts_bam(con, "cram_reads", cram_path, reference = ref_path, overwrite = TRUE)
cram_reads <- dbGetQuery(con, "SELECT QNAME, FLAG, POS, MAPQ FROM cram_reads LIMIT 5")
cram_reads
```

## System Requirements

We require zlib and libbz2, and we optionally use liblzma, libcurl, and openssl during build. We build with cmake, GNU make, and a C compiler. On Ubuntu/Debian we install build-essential, cmake, and the listed dev packages. On macOS we install cmake and htslib. On Windows we use Rtools and MinGW.

## Notes

We follow the RBCFTools pattern and create DuckDB tables rather than returning data frames. We check for existing tables and require `overwrite = TRUE` to replace them. We use region queries for indexed files, we bundle htslib 1.23, and we enable plugins where supported.

## References

We reference DuckDB, htslib, and RBCFTools as the primary upstream projects that inform this work.

## License

GPL-3.

```{r}
dbDisconnect(con, shutdown = TRUE)
```