#!/bin/sh
# configure.win script for Rduckhts package (Windows)
# Clean, direct approach - no slop

set -eu

THIS_DIR=`dirname "$0"`
THIS_DIR=`cd "$THIS_DIR" && pwd`

EXT_DIR="${THIS_DIR}/inst/duckhts_extension"

if [ ! -d "${EXT_DIR}/htslib" ]; then
    echo "ERROR: htslib sources not found in inst/duckhts_extension/"
    echo "Package may not be built properly. Sources should be bundled during package creation."
    exit 1
fi

# Get R's compiler settings for Windows
MAKE=`"${R_HOME}/bin/R" CMD config MAKE`
CC=`"${R_HOME}/bin/R" CMD config CC`
AR=`"${R_HOME}/bin/R" CMD config AR`
RANLIB=`"${R_HOME}/bin/R" CMD config RANLIB`
R_CPPFLAGS=`"${R_HOME}/bin/R" CMD config CPPFLAGS`
R_CFLAGS=`"${R_HOME}/bin/R" CMD config CFLAGS`
R_CPICFLAGS=`"${R_HOME}/bin/R" CMD config CPICFLAGS`
R_LDFLAGS=`"${R_HOME}/bin/R" CMD config LDFLAGS`
if [ -z "${RANLIB}" ]; then
    RANLIB=ranlib
fi

HTSLIB_DIR="${EXT_DIR}/htslib"
DUCKDB_CAPI_HEADER="${EXT_DIR}/duckdb_capi/duckdb_extension.h"
CFLAGS="${R_CFLAGS} ${R_CPICFLAGS} -O2 -fPIC -D_FILE_OFFSET_BITS=64"
CPPFLAGS="${R_CPPFLAGS} -DNDEBUG"
LDFLAGS="${R_LDFLAGS}"

if [ ! -f "${DUCKDB_CAPI_HEADER}" ]; then
    echo "ERROR: DuckDB C API header not found at ${DUCKDB_CAPI_HEADER}"
    echo "Package may not be built properly. Sources should be bundled during package creation."
    exit 1
fi

EXT_VERSION=`awk -F': *' '/^Version:/ {print $2; exit}' "${THIS_DIR}/DESCRIPTION" || true`
if [ -z "${EXT_VERSION}" ]; then
    EXT_VERSION="0.0.0"
fi

DUCKDB_API_MAJOR=`awk '/DUCKDB_EXTENSION_API_VERSION_MAJOR/ {print $3; exit}' "${DUCKDB_CAPI_HEADER}" || true`
DUCKDB_API_MINOR=`awk '/DUCKDB_EXTENSION_API_VERSION_MINOR/ {print $3; exit}' "${DUCKDB_CAPI_HEADER}" || true`
DUCKDB_API_PATCH=`awk '/DUCKDB_EXTENSION_API_VERSION_PATCH/ {print $3; exit}' "${DUCKDB_CAPI_HEADER}" || true`
if [ -n "${DUCKDB_API_MAJOR}" ] && [ -n "${DUCKDB_API_MINOR}" ] && [ -n "${DUCKDB_API_PATCH}" ]; then
    DUCKDB_VERSION="v${DUCKDB_API_MAJOR}.${DUCKDB_API_MINOR}.${DUCKDB_API_PATCH}"
else
    DUCKDB_VERSION="v1.2.0"
fi

OS_NAME=`uname -s`
ARCH_NAME=`uname -m`
DUCKDB_PLATFORM=""
case "${OS_NAME}" in
    *MINGW*|*MSYS*|*CYGWIN*)
        case "${ARCH_NAME}" in
            x86_64) DUCKDB_PLATFORM="windows_amd64_mingw";;
            aarch64|arm64) DUCKDB_PLATFORM="windows_arm64_mingw";;
        esac
        ;;
esac

if [ -z "${DUCKDB_PLATFORM}" ]; then
    echo "ERROR: Unsupported platform: ${OS_NAME}/${ARCH_NAME}"
    exit 1
fi

echo "---------- Checking for required libraries (Windows) ----------"

# Simple compile test - Windows version
try_compile() {
    lib_name=$1
    lib_flag=$2
    required=$3
    
    echo "Checking for ${lib_name}..."
    
    cat > conftest.c << EOF
#include <stdio.h>
int main() { return 0; }
EOF

    if ${CC} ${CFLAGS} ${CPPFLAGS} ${LDFLAGS} ${lib_flag} -o conftest conftest.c 2>/dev/null; then
        echo "  ${lib_name}: found"
        rm -f conftest conftest.c
        return 0
    else
        echo "  ${lib_name}: not found"
        rm -f conftest conftest.c
        if [ "${required}" = "yes" ]; then
            echo "ERROR: ${lib_name} is required but not found"
            exit 1
        fi
        return 1
    fi
}

try_compile_header_lib() {
    lib_name=$1
    header=$2
    lib_flag=$3
    required=$4

    echo "Checking for ${lib_name} (${header}, ${lib_flag})..."

    cat > conftest.c << EOF
#include <${header}>
int main() { return 0; }
EOF

    if ${CC} ${CFLAGS} ${CPPFLAGS} ${LDFLAGS} ${lib_flag} -o conftest conftest.c 2>/dev/null; then
        echo "  ${lib_name}: found"
        rm -f conftest conftest.c
        return 0
    else
        echo "  ${lib_name}: not found"
        rm -f conftest conftest.c
        if [ "${required}" = "yes" ]; then
            echo "ERROR: ${lib_name} is required but not found"
            exit 1
        fi
        return 1
    fi
}

# Check libraries
HAS_ZLIB=no
HAS_BZ2=no
HAS_LZMA=no
HAS_CURL=no
HAS_OPENSSL=no
HAS_REGEX=no
HAS_LIBDEFLATE=no
HAS_DLOPEN=no

LIBS=""

if try_compile "zlib" "-lz" "yes"; then
    HAS_ZLIB=yes
    LIBS="$LIBS -lz"
fi

if try_compile "bz2" "-lbz2" "yes"; then
    HAS_BZ2=yes
    LIBS="$LIBS -lbz2"
    echo "INFO: libbz2 found - BZ2 support enabled in htslib"
fi

if try_compile "lzma" "-llzma" "no"; then
    HAS_LZMA=yes
    LIBS="$LIBS -llzma"
    echo "INFO: liblzma found - XZ support enabled in htslib"
fi

if try_compile "curl" "-lcurl" "no"; then
    HAS_CURL=yes
    LIBS="$LIBS -lcurl"
    echo "INFO: libcurl found - remote URL support enabled in htslib"
fi

if try_compile "ssl" "-lssl" "no"; then
    HAS_OPENSSL=yes
    LIBS="$LIBS -lssl -lcrypto"
    echo "INFO: OpenSSL found - HTTPS support enabled in htslib"
fi

if try_compile "libdeflate" "-ldeflate" "no"; then
    HAS_LIBDEFLATE=yes
    LIBS="$LIBS -ldeflate"
    echo "INFO: libdeflate found - deflate support enabled in htslib"
fi

if try_compile "dl" "-ldl" "no"; then
    HAS_DLOPEN=yes
    LIBS="$LIBS -ldl"
fi

# MinGW regex (regcomp/regexec are in libgnurx or libregex)
case "${OS_NAME}" in
    *MINGW*|*MSYS*|*CYGWIN*)
        if try_compile_header_lib "gnurx" "regex.h" "-lgnurx" "no"; then
            HAS_REGEX=yes
            LIBS="$LIBS -lgnurx"
        elif try_compile_header_lib "regex" "regex.h" "-lregex" "no"; then
            HAS_REGEX=yes
            LIBS="$LIBS -lregex"
        fi
        ;;
esac

# Windows-specific libraries
LIBS="$LIBS -lpthread -lws2_32"

echo "---------- Configuring htslib (Windows) ----------"
cd "${HTSLIB_DIR}"

# Build htslib configure flags
HTSLIB_CONFIGURE_FLAGS="--disable-plugins"

if [ "$HAS_BZ2" = "no" ]; then
    echo "INFO: libbz2 not found - disabling BZ2 support in htslib"
    HTSLIB_CONFIGURE_FLAGS="$HTSLIB_CONFIGURE_FLAGS --disable-bz2"
fi

if [ "$HAS_LZMA" = "no" ]; then
    echo "INFO: liblzma not found - disabling XZ support in htslib"
    HTSLIB_CONFIGURE_FLAGS="$HTSLIB_CONFIGURE_FLAGS --disable-lzma"
fi

if [ "$HAS_CURL" = "no" ]; then
    echo "INFO: libcurl not found - disabling remote URL support in htslib"
    HTSLIB_CONFIGURE_FLAGS="$HTSLIB_CONFIGURE_FLAGS --disable-libcurl"
fi

if [ "$HAS_LIBDEFLATE" = "no" ]; then
    echo "INFO: libdeflate not found - disabling libdeflate support in htslib"
    HTSLIB_CONFIGURE_FLAGS="$HTSLIB_CONFIGURE_FLAGS --disable-libdeflate"
fi

# Configure htslib for Windows/MinGW
CONFIGURE_BUILD_HOST=""
if [ -n "${BUILD:-}" ]; then
    CONFIGURE_BUILD_HOST="${CONFIGURE_BUILD_HOST} --build=${BUILD}"
fi
if [ -n "${HOST:-}" ]; then
    CONFIGURE_BUILD_HOST="${CONFIGURE_BUILD_HOST} --host=${HOST}"
fi

./configure \
    CC="${CC}" \
    AR="${AR}" \
    RANLIB="${RANLIB}" \
    CFLAGS="${CFLAGS}" \
    CPPFLAGS="${CPPFLAGS}" \
    LDFLAGS="${LDFLAGS}" \
    LIBS="${LIBS}" \
    ${CONFIGURE_BUILD_HOST} \
    ${HTSLIB_CONFIGURE_FLAGS}

echo "---------- Building htslib (static) ----------"
${MAKE} -j1 lib-static

rm -rf "${HTSLIB_DIR}/bin" "${HTSLIB_DIR}/htscodecs/tests" "${HTSLIB_DIR}/test" || true

if [ ! -f "libhts.a" ]; then
    echo "ERROR: htslib build failed - libhts.a not found"
    exit 1
fi

echo "---------- Building DuckHTS extension (Windows) ----------"

# Build the extension
cd "${EXT_DIR}"

C_SOURCES="duckhts.c bcf_reader.c bam_reader.c seq_reader.c tabix_reader.c vep_parser.c"
INCLUDES="-I./include -I./duckdb_capi -I./htslib"

echo "Compiling extension sources for Windows..."
OBJECT_FILES=""
for src_file in $C_SOURCES; do
    obj_file="${src_file%.c}.o"
    echo "  Compiling $src_file -> $obj_file"
    ${CC} ${CFLAGS} ${INCLUDES} -c "$src_file" -o "$obj_file"
    if [ $? -ne 0 ]; then
        echo "ERROR: Failed to compile $src_file"
        exit 1
    fi
    OBJECT_FILES="$OBJECT_FILES $obj_file"
done

BUILD_DIR="${THIS_DIR}/inst/duckhts_extension/build"
mkdir -p "${BUILD_DIR}"

# Link the extension for Windows
echo "Linking DuckHTS extension for Windows..."
RAW_EXT_FILE="${BUILD_DIR}/duckhts.duckdb_extension.raw"
FINAL_EXT_FILE="${BUILD_DIR}/duckhts.duckdb_extension"
${CC} -shared -o "${RAW_EXT_FILE}" \
    $OBJECT_FILES \
    ./htslib/libhts.a \
    $LIBS

if [ $? -ne 0 ]; then
    echo "ERROR: Failed to link DuckHTS extension"
    exit 1
fi

echo "---------- Cleaning up build artifacts ----------"
rm -f $OBJECT_FILES

echo "Appending DuckDB extension metadata..."
"${R_HOME}/bin/Rscript" "${THIS_DIR}/tools/append_extension_metadata.R" \
    --library-file "${RAW_EXT_FILE}" \
    --out-file "${FINAL_EXT_FILE}" \
    --extension-name "duckhts" \
    --duckdb-platform "${DUCKDB_PLATFORM}" \
    --duckdb-version "${DUCKDB_VERSION}" \
    --extension-version "${EXT_VERSION}" \
    --abi-type "C_STRUCT"

echo "---------- DuckHTS extension built successfully for Windows ----------"
ls -la "${FINAL_EXT_FILE}"

rm -f "${RAW_EXT_FILE}"

cd "${THIS_DIR}"
echo "Windows configure complete."
